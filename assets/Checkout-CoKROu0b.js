import{A as q,R as e,p as j,q as B,r as d,s as D,F as W,t as Z,v as _,w as M,x as ee,y as te,u as U,z as re,e as ae}from"./index-Py7kvHa0.js";import{a as oe}from"./products-DZsIXrs4.js";import{s as $}from"./toastHelper-Cmf0APRO.js";import{B as ne}from"./Button-V8RViXZE.js";import{p as R,d as se,s as O}from"./inputSanitizer-B2bR0dzU.js";import{C as le}from"./CartItem-CHA7lBGK.js";import"./StockIndicator-Bg18On1j.js";import"./CardInformations-BRbc6VdB.js";const ce=async r=>(await q.post("/orders/send-verification",r)).data,ie=async(r,t)=>(await q.post("/orders/verify-and-create",{email:r,code:t})).data,J=r=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r),K=r=>{const t=r.replace(/\D/g,""),o=["010","011","012","015"];return/^01[0-5][0-9]{8}$/.test(t)&&o.some(y=>t.startsWith(y))},Y=r=>{if(!r||typeof r!="string")return!1;const t=r.trim();return t.length<2||t.length>50?!1:/^[a-zA-Z\u0600-\u06FF\s\-'\.]+$/.test(t)},H=r=>{if(!r||typeof r!="string")return!1;const t=r.trim();return t.length>=10&&t.length<=200},Q=r=>{if(!r||typeof r!="string")return!1;const t=r.trim();return t.length>=2&&t.length<=50},X=r=>{if(!Array.isArray(r)||r.length===0)return{isValid:!1,error:"Cart is empty. Please add items before checkout."};for(let t=0;t<r.length;t++){const o=r[t];if(!o.productId)return{isValid:!1,error:`Item ${t+1}: Product ID is required.`};if(!o.variantId)return{isValid:!1,error:`Item ${t+1}: Variant ID is required.`};if(!o.quantity||typeof o.quantity!="number"||o.quantity<=0||o.quantity>100)return{isValid:!1,error:`Item ${t+1}: Quantity must be between 1 and 100.`}}return{isValid:!0}},me=r=>{const t=[];if(!r.customer)return t.push("Customer information is required."),{isValid:!1,errors:t};const{customer:o}=r;Y(o.name)||t.push("Please enter a valid name (2-50 characters, letters only)."),J(o.email)||t.push("Please enter a valid email address."),K(o.phone)||t.push("Please enter a valid Egyptian phone number (010, 011, 012, or 015 followed by 8 digits)."),Q(o.governorate)||t.push("Please select a governorate."),H(o.deliveryLocation)||t.push("Please enter a complete delivery address (10-200 characters).");const m=X(r.items);return m.isValid||t.push(m.error),r.total&&(typeof r.total!="number"||r.total<=0)&&t.push("Invalid order total."),{isValid:t.length===0,errors:t}},de=(r,t,o={})=>{switch(r){case"name":return Y(t)?null:"Please enter a valid name (2-50 characters, letters only).";case"email":return J(t)?null:"Please enter a valid email address.";case"phone":return K(t)?null:"Please enter a valid Egyptian phone number (010, 011, 012, or 015 followed by 8 digits).";case"governorate":return Q(t)?null:"Please select a governorate.";case"deliveryLocation":return H(t)?null:"Please enter a complete delivery address (10-200 characters).";case"items":const m=X(t);return m.isValid?null:m.error;default:return null}},ue=r=>{const t={...r};return t.customer&&(t.customer.name=t.customer.name?.trim()||"",t.customer.email=t.customer.email?.trim().toLowerCase()||"",t.customer.phone=t.customer.phone?.trim()||"",t.customer.governorate=t.customer.governorate?.trim()||"",t.customer.deliveryLocation=t.customer.deliveryLocation?.trim()||""),t.items&&Array.isArray(t.items)&&(t.items=t.items.map(o=>({...o,productId:o.productId?.trim()||"",variantId:o.variantId?.trim()||"",quantity:parseInt(o.quantity)}))),t.location&&(t.location.governorate=t.location.governorate?.trim()||"",t.location.city=t.location.city?.trim()||""),t},pe=({onCheckout:r,onClose:t,loading:o})=>e.createElement("div",{className:"flex flex-col space-y-3 xl:space-y-4"},e.createElement(ne,{onClick:r,className:`
                    w-full py-4 rounded-full text-[var(--color-text)] font-bold text-lg transition-all transform hover:scale-105 shadow-lg
                    ${o?"bg-[var(--color-main-light)] cursor-not-allowed":"bg-[var(--color-main)] hover:bg-[var(--color-main-dark)]"}
                `},o?e.createElement("span",{className:"flex items-center justify-center space-x-2"},e.createElement(j,{size:20,className:"animate-spin"}),e.createElement("span",null,"Placing Order...")):e.createElement("span",{className:"flex items-center justify-center space-x-2"},e.createElement(B,{size:20}),e.createElement("span",null,"Place Order"))),e.createElement("button",{onClick:t,className:"w-full py-4 rounded-full text-[var(--color-text)] font-semibold text-lg border border-[var(--color-border)] transition-all transform hover:scale-105 hover:bg-[var(--color-hover)]"},"Cancel")),ve=async r=>(await q.get(`/shipping/search?q=${encodeURIComponent(r)}`)).data,fe=async(r,t,o)=>(await q.post("/shipping/calculate",{governorate:r,city:t,orderTotal:o})).data,ge=async()=>(await q.get("/shipping/governorates")).data,he=({setShowGovernorateSelect:r,showGovernorateSelect:t,onLocationChange:o,error:m,className:y=""})=>{const[g,h]=d.useState(""),[N,b]=d.useState([]),[V,w]=d.useState(!1),[F,l]=d.useState(!1),[x,E]=d.useState(null),[f,v]=d.useState(0),[u,C]=d.useState([]),S=d.useRef(null);d.useEffect(()=>{(async()=>{try{const p=await ge();p.success&&C(p.data)}catch(p){console.error("Error loading governorates:",p)}})()},[]),d.useEffect(()=>{const c=setTimeout(()=>{g.length>=2?I(g):(b([]),w(!1))},300);return()=>clearTimeout(c)},[g]);const I=async c=>{l(!0),r(!1);try{const p=await ve(c);p.success&&(b(p.data),w(!0),p.data.length===0&&r(!0))}catch(p){console.error("Location search error:",p),b([]),r(!0)}finally{l(!1)}},A=async c=>{h(c.label),E(c),w(!1),b([]),r(!1);try{const p=await fe(c.governorate,c.city,0);if(p.success){const a=p.data.finalShipping;v(a),o({governorate:c.governorate,city:c.city,shippingCost:a})}}catch(p){console.error("Shipping calculation error:",p)}},z=async c=>{const p=u.find(a=>a.name===c);if(p){const a={governorate:p.name,city:g,shippingCost:p.shippingPrice};E(a),v(p.shippingPrice),w(!1),r(!1),o(a)}},G=()=>{h(""),E(null),v(0),w(!1),b([]),r(!1),o({governorate:"",city:"",shippingCost:0})},L=c=>{S.current&&!S.current.contains(c.target)&&w(!1)};return d.useEffect(()=>(document.addEventListener("mousedown",L),()=>document.removeEventListener("mousedown",L)),[]),e.createElement("div",{className:`relative ${y}`,ref:S},e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Location *"),e.createElement("div",{className:"relative"},e.createElement("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-[var(--color-text-light)]"},e.createElement(D,{size:16})),e.createElement("input",{type:"text",value:g,onChange:c=>h(c.target.value),className:`w-full pl-10 pr-10 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors ${m?"border-[var(--color-error)]":"border-[var(--color-border)]"}`,placeholder:"Type city or governorate name...",autoComplete:"off"}),g&&e.createElement("button",{onClick:G,className:"absolute right-3 top-1/2 -translate-y-1/2 text-[var(--color-text-light)] hover:text-[var(--color-text)] transition-colors"},e.createElement(W,{size:16}))),V&&e.createElement("div",{className:"absolute z-50 w-full mt-1 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg shadow-lg max-h-60 overflow-y-auto"},F?e.createElement("div",{className:"p-3 text-center text-[var(--color-text-light)]"},"Searching..."):N.length>0?N.map((c,p)=>e.createElement("button",{key:p,onClick:()=>A(c),className:"w-full px-4 py-3 text-left hover:bg-[var(--color-hover)] transition-colors border-b border-[var(--color-border)] last:border-b-0"},e.createElement("div",{className:"font-medium text-[var(--color-text)]"},c.label),e.createElement("div",{className:"text-sm text-[var(--color-text-light)]"},c.governorate))):g.length>=2?e.createElement("div",{className:"p-3 text-center text-[var(--color-text-light)]"},"No locations found"):null),t&&e.createElement("div",{className:"mt-4 p-5 bg-[var(--color-stock-low-bg)] border border-[var(--color-stock-low)] rounded-xl shadow-md transition-all duration-300 transform animate-fade-in"},e.createElement("div",{className:"flex items-start text-[var(--color-stock-low-text)] mb-4 space-x-3"},e.createElement(Z,{className:"h-5 w-5 mt-0.5"}),e.createElement("div",null,e.createElement("span",{className:"font-semibold text-base block"},'City "',g,'" not found'),e.createElement("p",{className:"text-sm"},"Please select the correct governorate from the list below to proceed."))),e.createElement("div",{className:"space-y-3"},e.createElement("label",{className:"block text-sm font-medium text-[var(--color-form-label)]"},"Select Governorate"),e.createElement("div",{className:"relative"},e.createElement("select",{onChange:c=>z(c.target.value),className:"w-full px-4 py-3 border border-[var(--color-border)] rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-[var(--color-error)] bg-[var(--color-background)] text-[var(--color-text)] transition-colors pr-10"},e.createElement("option",{value:""},"Choose a Governorate"),u.map(c=>e.createElement("option",{key:c.id,value:c.name},c.name," - ",c.shippingPrice," EGP shipping"))),e.createElement("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--color-text-light)]"},e.createElement(_,{className:"h-4 w-4"}))))),x&&e.createElement("div",{className:"mt-2 p-3 text-[var(--color-success)] bg-[var(--color-success)]/10 border border-[var(--color-green)]/30 rounded-lg"},e.createElement("div",{className:"flex items-center text-sm"},e.createElement(B,{className:"h-4 w-4 mr-2"}),e.createElement("span",null,e.createElement("strong",null,x.city),", ",x.governorate,f>0&&e.createElement("span",{className:"ml-2 font-semibold"},"â€¢ Shipping: ",f," EGP")))),m&&e.createElement("p",{className:"text-[var(--color-error)] text-xs mt-1"},m))},xe=async(r,t,o,m)=>(await q.post("/coupons/validate",{couponCode:r,cartItems:t,userEmail:o,subtotal:m})).data,be=(r,t)=>{if(!r||r.trim()==="")return{isValid:!1,message:"Email is required to use this coupon"};if(!t)return{isValid:!1,message:"No coupon provided"};if(!t.restrictedEmails||t.restrictedEmails.length===0)return{isValid:!0,message:"Email is valid for this coupon"};const o=r.toLowerCase().trim();return t.restrictedEmails.some(y=>y.toLowerCase().trim()===o)?{isValid:!0,message:"Email is valid for this coupon"}:{isValid:!1,message:"This coupon is not available for your email address"}},Ee=({customerInfo:r,setCustomerInfo:t,errors:o,cartItems:m,onCheckout:y,onClose:g,loading:h,setNoteMessage:N})=>{const[b,V]=d.useState(0),[w,F]=d.useState(!1),[l,x]=d.useState(null),[E,f]=d.useState(!1),v=a=>{t(n=>({...n,governorate:a.governorate,city:a.city})),V(a.shippingCost||0)},u=a=>{let n=a.target.value;n=R(n),t(i=>({...i,name:n}))},C=a=>{let n=se(a.target.value);t(i=>({...i,phone:n}))},S=a=>{let n=a.target.value;n=R(n),t(i=>({...i,street:n}))},I=a=>{let n=O(a.target.value);t(i=>({...i,buildingNumber:n}))},A=a=>{let n=O(a.target.value);t(i=>({...i,floor:n}))},z=async a=>{const n=a.target.value.toUpperCase();t(i=>({...i,coupon:n})),await G(n,r.email)},G=async(a,n)=>{if(!a||a.trim()===""||a.length<3){x(null);return}if(!n||n.trim()===""){x({valid:!1,message:"Please enter your email address first to validate the coupon",type:"error",discount:0});return}f(!0);try{const i=m.reduce((P,k)=>P+k.price*k.quantity,0),s=await xe(a,m.map(P=>({name:P.name,category:P.category,price:P.price})),n,i);if(s.success){const P=be(n,s.data);P.isValid?x({valid:!0,message:s.message,type:s.data.discountType==="FREE_SHIPPING"?"shipping":"percent",discount:s.data.discountAmount||0,couponData:s.data}):x({valid:!1,message:P.message,type:"error",discount:0})}else x({valid:!1,message:s.message,type:"error",discount:0})}catch(i){x({valid:!1,message:i?.response?.data?.message||"Error validating coupon",type:"error",discount:0})}finally{f(!1)}},L=a=>`${a.street}, ${a.city}, ${a.governorate}${a.buildingNumber?`, Building ${a.buildingNumber}`:""}${a.floor?`, Floor ${a.floor}`:""}`,c=()=>{const a={};return r.name?.trim()||(a.name="Name is required"),r.email?.trim()||(a.email="Email is required"),r.phone?.trim()||(a.phone="Phone is required"),r.street?.trim()||(a.street="Street address is required"),r.governorate?.trim()||(a.governorate="Governorate is required",F(!0)),r.city?.trim()||(a.city="City is required"),{isValid:Object.keys(a).length===0,errors:a}},p=async()=>{const a=c();if(!a.isValid){const s=Object.values(a.errors)[0];$(N,s,!1);return}const n=L(r),i={customer:{...r,deliveryLocation:n},items:m.map(s=>({productId:s.productId,variantId:s.variantId,quantity:s.quantity})),location:{governorate:r.governorate,city:r.city}};await y(i)};return e.createElement("div",{className:"p-4 sm:p-6 lg:p-8"},e.createElement("button",{onClick:g,className:"mb-6 flex items-center text-[var(--color-white)] hover:text-[var(--color-text)] transition-colors"},e.createElement(M,{className:"mr-2",size:16}),"Back to Cart"),e.createElement("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8"},e.createElement("section",{className:"rounded-2xl p-6 shadow-lg border border-[var(--color-border)]"},e.createElement("header",{className:"text-lg xl:text-xl font-semibold text-[var(--color-text)] mb-6 flex items-center"},e.createElement("div",{className:"w-10 xl:w-12 h-10 xl:h-12 bg-[var(--color-main)] rounded-lg xl:rounded-xl flex items-center justify-center mr-3 xl:mr-4"},e.createElement(ee,{className:"text-[var(--color-background)]",size:18})),"Checkout Information"),e.createElement("section",{className:"space-y-6"},e.createElement("section",{className:"space-y-4"},e.createElement("h4",{className:"text-md font-medium text-[var(--color-text)]"},"Personal Information"),e.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4"},e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Full Name *"),e.createElement("input",{type:"text",value:r.name,onChange:u,className:`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors ${o.name?"border-[var(--color-error)]":"border-[var(--color-border)]"}`,placeholder:"Enter your full name"}),o.name&&e.createElement("p",{className:"text-[var(--color-error)] text-xs mt-1"},o.name)),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Email Address *"),e.createElement("input",{type:"email",value:r.email,onChange:async a=>{const n=a.target.value;t(i=>({...i,email:n,coupon:""})),x(null)},className:`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors ${o.email?"border-[var(--color-error)]":"border-[var(--color-border)]"}`,placeholder:"Enter your email"}),o.email&&e.createElement("p",{className:"text-[var(--color-error)] text-xs mt-1"},o.email))),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Phone Number *"),e.createElement("input",{type:"tel",value:r.phone,onChange:C,className:`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors ${o.phone?"border-[var(--color-error)]":"border-[var(--color-border)]"}`,placeholder:"Enter your phone number"}),o.phone&&e.createElement("p",{className:"text-[var(--color-error)] text-xs mt-1"},o.phone))),e.createElement("section",{className:"space-y-4"},e.createElement("h4",{className:"text-md font-medium text-[var(--color-text)] flex items-center"},e.createElement(D,{className:"mr-2",size:16}),"Delivery Address"),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Street Address *"),e.createElement("input",{type:"text",value:r.street,onChange:S,className:`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors ${o.street?"border-[var(--color-error)]":"border-[var(--color-border)]"}`,placeholder:"Enter street address"}),o.street&&e.createElement("p",{className:"text-[var(--color-error)] text-xs mt-1"},o.street)),e.createElement(he,{onLocationChange:v,error:o.governorate||o.city,setShowGovernorateSelect:F,showGovernorateSelect:w}),e.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4"},e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Building Number"),e.createElement("input",{type:"text",value:r.buildingNumber,onChange:I,className:"w-full px-4 py-3 border border-[var(--color-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors",placeholder:"Building number"})),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-[var(--color-text)] mb-2"},"Floor"),e.createElement("input",{type:"text",value:r.floor,onChange:A,className:"w-full px-4 py-3 border border-[var(--color-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-colors",placeholder:"Floor number"})))))),e.createElement("div",{className:"space-y-6"},e.createElement("section",{className:" rounded-xl p-3 border border-[var(--color-border)]"},e.createElement("header",null,e.createElement("h3",{className:"text-lg font-semibold text-[var(--color-text)] mb-4"},"Order Items")),e.createElement("section",{className:"space-y-4"},m.map((a,n)=>e.createElement(le,{item:a,key:n,isCheckout:!0})))),e.createElement("section",{className:" rounded-xl p-6 border border-[var(--color-border)]"},e.createElement("h3",{className:"text-lg font-semibold text-[var(--color-text)] mb-4 flex items-center gap-2"},e.createElement(te,{className:"w-5 h-5 text-[var(--color-main)]"}),"Coupon Code"),e.createElement("div",{className:"relative"},e.createElement("div",{className:"flex gap-2"},e.createElement("input",{type:"text",value:r.coupon||"",onChange:z,className:"flex-1 px-4 py-3 border border-[var(--color-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-main)] input-color transition-all duration-200 font-mono text-lg tracking-wider",placeholder:"Enter coupon code"}),E&&e.createElement("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2"},e.createElement(j,{className:"animate-spin text-[var(--color-main)]",size:20}))),l&&e.createElement("div",{className:`mt-4 p-4 rounded-xl border-2 transition-all duration-300 ${l.valid?"bg-[var(--color-success)]/5 border-[var(--color-success)]/20 shadow-[var(--color-success)]/10 shadow-sm":"bg-[var(--color-error)]/5 border-[var(--color-error)]/20 shadow-[var(--color-error)]/10 shadow-sm"}`},e.createElement("div",{className:"flex items-center gap-3"},e.createElement("div",{className:`p-2 rounded-full ${l.valid?"bg-[var(--color-success)]/10 text-[var(--color-success)]":"bg-[var(--color-error)]/10 text-[var(--color-error)]"}`},l.valid?e.createElement(B,{size:20}):e.createElement(W,{size:20})),e.createElement("div",{className:"flex-1"},e.createElement("p",{className:`font-semibold text-sm ${l.valid?"text-[var(--color-success)]":"text-[var(--color-error)]"}`},l.message),l.valid&&l.type==="percent"&&e.createElement("div",{className:"mt-2 flex items-center gap-2"},e.createElement("span",{className:"text-xs text-[var(--color-success)] bg-[var(--color-success)]/10 px-2 py-1 rounded-full font-medium"},"ðŸ’° Save ",l.discount.toFixed(2)," EGP")),l.valid&&l.type==="shipping"&&e.createElement("div",{className:"mt-2 flex items-center gap-2"},e.createElement("span",{className:"text-xs text-[var(--color-success)] bg-[var(--color-success)]/10 px-2 py-1 rounded-full font-medium"},"ðŸšš Free Shipping"))))),r.coupon&&!l&&!E&&e.createElement("div",{className:"mt-3 p-3 bg-[var(--color-hover)] rounded-lg"},e.createElement("p",{className:"text-sm text-[var(--color-text-light)]"},"Coupon code: ",e.createElement("span",{className:"font-mono font-bold text-[var(--color-text)]"},r.coupon))))),e.createElement("section",{className:" rounded-xl p-4 border border-[var(--color-border)]"},e.createElement("h3",{className:"text-lg font-semibold text-[var(--color-text)] mb-4"},"Order Summary"),e.createElement("div",{className:"space-y-2"},e.createElement("div",{className:"flex justify-between items-center text-sm"},e.createElement("span",{className:"text-[var(--color-text)]"},"Subtotal:"),e.createElement("span",{className:"text-[var(--color-text)]"},m.reduce((a,n)=>a+n.price*n.quantity,0).toFixed(2)," EGP")),l&&l.valid&&e.createElement("div",{className:"flex justify-between items-center text-sm"},e.createElement("span",{className:"text-[var(--color-error)] font-medium"},"Discount:"),e.createElement("span",{className:"text-[var(--color-error)] font-medium"},"-",l.discount.toFixed(2)," EGP")),e.createElement("div",{className:"flex justify-between items-center text-sm"},e.createElement("span",{className:"text-[var(--color-text)]"},"Shipping:"),e.createElement("span",{className:"text-[var(--color-text)]"},l&&l.valid&&l.type==="shipping"?"FREE":b>0?`${b.toFixed(2)} EGP`:"Calculating...")),e.createElement("div",{className:"border-t border-[var(--color-border)] pt-2"},e.createElement("div",{className:"flex justify-between items-center font-bold text-lg"},e.createElement("span",{className:"text-[var(--color-text)]"},"Total:"),e.createElement("span",{className:"text-[var(--color-success)]"},(()=>{const a=m.reduce((i,s)=>i+s.price*s.quantity,0);let n=a+b;return l&&l.valid&&(l.type==="shipping"?n=a:n-=l.discount),n.toFixed(2)})()," EGP"))))),e.createElement(pe,{onCheckout:p,onClose:g,loading:h}))))},ye=({customerInfo:r,setCustomerInfo:t,handleFieldChange:o,errors:m,cartItems:y,calculateTotal:g,onCheckout:h,onClose:N,loading:b,setNoteMessage:V})=>e.createElement("div",{className:"min-h-screen"},e.createElement("div",{className:"container mx-auto py-8"},e.createElement(Ee,{customerInfo:r,setCustomerInfo:t,handleFieldChange:o,errors:m,cartItems:y,calculateTotal:g,onCheckout:h,onClose:N,loading:b,setNoteMessage:V}))),Ne=({customerInfo:r,verificationCode:t,setVerificationCode:o,timeLeft:m,onBack:y,setNoteMessage:g})=>{const h=d.useRef([]),[N,b]=d.useState(!1),V=U(),w=async()=>{b(!0);try{const f=await ie(r.email,t);$(g,f.message||"Verification successful! Your order has been placed.",!0),localStorage.removeItem("cart"),V("/home")}catch(f){$(g,f?.response?.data?.message||"Invalid verification code",!1),h.current[0]&&h.current[0].focus()}finally{b(!1),o("")}};d.useEffect(()=>{t?.length===6&&!N&&w()},[t,N]);const F=(f,v)=>{const{value:u}=f.target;if(/[0-9]/.test(u)||u===""){const C=(t?.padEnd(6," ")||"").split("");C[v]=u;const S=C.join("").replace(/ /g,"");o(S),u!==""&&v<5&&h.current[v+1].focus()}},l=(f,v)=>{if(f.key==="Backspace"&&f.target.value===""&&v>0){const u=(t?.padEnd(6," ")||"").split("");u[v-1]=" ";const C=u.join("").replace(/ /g,"");o(C),h.current[v-1].focus()}},x=f=>{const u=f.clipboardData.getData("text").replace(/\D/g,"").slice(0,6);u.length>0&&(o(u),u.length===6?h.current[5].focus():u.length>0&&h.current[u.length-1].focus())},E=(t?.padEnd(6," ")||"").split("");return e.createElement("div",{className:"flex items-center justify-center min-h-screen p-4"},e.createElement("div",{className:"rounded-2xl shadow-xl w-full max-w-sm p-6 sm:p-8 border border-[var(--color-main)]"},e.createElement("div",{className:"space-y-6 text-center"},e.createElement("div",null,e.createElement("div",{className:"flex items-center justify-center mb-4"},e.createElement(re,{className:"w-12 h-12 text-[var(--color-main)]"})),e.createElement("h3",{className:"text-2xl font-bold text-[var(--color-main)] mb-2"},"Account Verification"),e.createElement("p",{className:"text-[var(--color-text-light)] text-sm"},"Enter the verification code sent to ",e.createElement("strong",{className:"text-[var(--color-text)]"},r?.email))),N?e.createElement("div",{className:"flex justify-center items-center my-6 h-12 sm:h-16"},e.createElement(j,{className:"w-10 h-10 sm:w-12 sm:h-12 text-[var(--color-main)] animate-spin"})):e.createElement("div",{className:"flex justify-center space-x-2 sm:space-x-3 my-6"},E.map((f,v)=>e.createElement("input",{key:v,ref:u=>h.current[v]=u,type:"text",maxLength:"1",autoFocus:v===0,value:f.trim(),onChange:u=>F(u,v),onKeyDown:u=>l(u,v),onPaste:x,className:"w-10 h-12 sm:w-12 sm:h-16 text-center text-xl sm:text-3xl font-bold rounded-lg border-2 border-[var(--color-border)] focus:border-[var(--color-main)] focus:outline-none input-color shadow-sm"}))),e.createElement("div",{className:"space-y-4"},m>0?e.createElement("p",{className:"text-[var(--color-white)] text-sm font-semibold"},"Code expires in: ",Math.floor(m/60),":",(m%60).toString().padStart(2,"0")):e.createElement("p",{className:"text-[var(--color-error)] text-sm font-semibold"},"Code expired.")),e.createElement("div",null,e.createElement("button",{onClick:y,className:"text-sm font-medium text-[var(--color-main)] hover:text-[var(--color-text)] disabled:text-[var(--color-text-light)] disabled:cursor-not-allowed transition-colors"},"Back")))))},Le=({setNoteMessage:r})=>{const t=U(),[o,m]=d.useState([]),[y,g]=d.useState(!1),[h,N]=d.useState(!1),[b,V]=d.useState(""),[w,F]=d.useState(!1),[l,x]=d.useState(0),[E,f]=d.useState({name:"",email:"",phone:"",street:"",city:"",governorate:"",buildingNumber:"",floor:"",coupon:""}),[v,u]=d.useState({}),[C,S]=d.useState(!0),I=(a,n)=>{f(s=>({...s,[a]:n}));const i=de(a,n);u(s=>({...s,[a]:i}))};d.useEffect(()=>{const a=localStorage.getItem("cart");if(a){const n=JSON.parse(a);if(n.length>0){if(n.filter(s=>!s.variantId).length>0){localStorage.removeItem("cart"),m([]),S(!1),$(r,"Your cart has been updated. Please re-add items to continue.",!1);return}m(n),A(n)}else S(!1)}else S(!1)},[]),d.useEffect(()=>{!C&&o.length===0&&t("/")},[C,o,t,r]);const A=async a=>{try{const n=await Promise.all(a.map(async i=>{try{const s=await oe(i.productId);return{...i,stock:s.data.stock}}catch{return i}}));m(n),localStorage.setItem("cart",JSON.stringify(n))}catch{}finally{S(!1)}};d.useEffect(()=>{let a=null;return l>0?a=setInterval(()=>{x(n=>n-1)},1e3):l===0&&w&&F(!1),()=>clearInterval(a)},[l,w]);const z=(a=0)=>o.reduce((i,s)=>i+s.price*s.quantity,0)+a,G=a=>`${a.street}, ${a.city}, ${a.governorate}${a.buildingNumber?`, Building ${a.buildingNumber}`:""}${a.floor?`, Floor ${a.floor}`:""}`,L=async()=>{if(o.filter(k=>!k.variantId).length>0){$(r,"Some items in your cart are missing variant information. Please remove and re-add them to your cart.",!1);return}const n=G(E),i={customer:{...E,deliveryLocation:n},items:o.map(k=>({productId:k.productId,variantId:k.variantId,quantity:k.quantity})),location:{governorate:E.governorate,city:E.city},coupon:E.coupon||null},s=ue(i),P=me(s);if(!P.isValid){$(r,P.errors[0],!1);return}g(!0);try{const k={customer:s.customer,items:s.items.map(T=>({productId:T.productId,variantId:T.variantId,quantity:T.quantity})),location:s.location,coupon:s.coupon};await ce(k),N(!0),F(!0),x(300),$(r,"Verification code sent to your email!",!0)}catch(k){$(r,k?.response?.data?.message||"Failed to send verification code",!1)}finally{g(!1)}},c=()=>{t("/cart")},p=()=>{N(!1),V(""),F(!1),x(0)};return C?e.createElement(ae,{text:"Loading checkout..."}):e.createElement("div",{className:"min-h-screen"},h?e.createElement(Ne,{customerInfo:E,verificationCode:b,setVerificationCode:V,timeLeft:l,onBack:p,setNoteMessage:r}):e.createElement(ye,{customerInfo:E,setCustomerInfo:f,handleFieldChange:I,errors:v,cartItems:o,calculateTotal:z,onCheckout:L,onClose:c,loading:y,setNoteMessage:r}))};export{Le as default};
